<!DOCTYPE html>

<html lang="en" data-content_root="../../../">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>XPER.viz.Visualisation &#8212; XPER Documentation 1.0.0 documentation</title>
    <link rel="stylesheet" type="text/css" href="../../../_static/pygments.css?v=d1102ebc" />
    <link rel="stylesheet" type="text/css" href="../../../_static/alabaster.css?v=12dfc556" />
    <script src="../../../_static/documentation_options.js?v=8d563738"></script>
    <script src="../../../_static/doctools.js?v=9a2dae69"></script>
    <script src="../../../_static/sphinx_highlight.js?v=dc90522c"></script>
    <link rel="index" title="Index" href="../../../genindex.html" />
    <link rel="search" title="Search" href="../../../search.html" />
   
  <link rel="stylesheet" href="../../../_static/custom.css" type="text/css" />
  

  
  

  </head><body>
  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          

          <div class="body" role="main">
            
  <h1>Source code for XPER.viz.Visualisation</h1><div class="highlight"><pre>
<span></span><span class="c1"># -*- coding: utf-8 -*-</span>
<span class="sd">&quot;&quot;&quot;</span>
<span class="sd">Created on Fri Jun 16 10:41:10 2023</span>

<span class="sd">@author: sebsa</span>
<span class="sd">&quot;&quot;&quot;</span>

<span class="c1"># =============================================================================</span>
<span class="c1">#                           Packages</span>
<span class="c1"># =============================================================================</span>
<span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>
<span class="kn">import</span> <span class="nn">seaborn</span> <span class="k">as</span> <span class="nn">sns</span>
<span class="kn">from</span> <span class="nn">matplotlib</span> <span class="kn">import</span> <span class="n">lines</span>
<span class="kn">from</span> <span class="nn">matplotlib.path</span> <span class="kn">import</span> <span class="n">Path</span>
<span class="kn">from</span> <span class="nn">matplotlib.patches</span> <span class="kn">import</span> <span class="n">PathPatch</span>
<span class="kn">import</span> <span class="nn">matplotlib</span>
<span class="kn">import</span> <span class="nn">plotly.graph_objects</span> <span class="k">as</span> <span class="nn">go</span>
<span class="kn">from</span> <span class="nn">plotly.subplots</span> <span class="kn">import</span> <span class="n">make_subplots</span>
<span class="kn">import</span> <span class="nn">plotly.express</span> <span class="k">as</span> <span class="nn">px</span>


<span class="kn">from</span> <span class="nn">XPER.compute.Performance</span> <span class="kn">import</span> <span class="n">ModelPerformance</span>

<span class="c1">#plt.rc(&#39;text&#39;, usetex = True) # TeX </span>


<div class="viewcode-block" id="visualizationClass">
<a class="viewcode-back" href="../../../XPER.viz.html#XPER.viz.Visualisation.visualizationClass">[docs]</a>
<span class="k">class</span> <span class="nc">visualizationClass</span><span class="p">(</span><span class="n">ModelPerformance</span><span class="p">):</span>
    
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">X_test</span><span class="p">,</span> <span class="n">labels</span><span class="p">,</span> <span class="n">XPER_values</span><span class="p">,</span> <span class="n">XPER_v</span><span class="p">,</span> <span class="n">XPER_v_ind</span><span class="p">,</span> <span class="n">benchmark_v_ind</span><span class="p">,</span><span class="n">p</span><span class="p">,</span><span class="n">X</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">X_test</span><span class="p">)</span>
        
        <span class="bp">self</span><span class="o">.</span><span class="n">X_test</span> <span class="o">=</span> <span class="n">X_test</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">labels</span> <span class="o">=</span> <span class="n">labels</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">XPER_values</span> <span class="o">=</span> <span class="n">XPER_values</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">XPER_v</span> <span class="o">=</span> <span class="n">XPER_values</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">XPER_v_ind</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">XPER_values</span><span class="p">[</span><span class="mi">1</span><span class="p">][:,</span><span class="mi">1</span><span class="p">:])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">benchmark_v_ind</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">XPER_values</span><span class="p">[</span><span class="mi">1</span><span class="p">][:,</span><span class="mi">0</span><span class="p">],</span><span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;Individual Benchmark&quot;</span><span class="p">])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">p</span> <span class="o">=</span>  <span class="n">X_test</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="c1"># Number of features</span>

    <span class="c1"># =============================================================================</span>
    <span class="c1">#       Bar plot: X-axis = phi_j value or pct // y-axis = Feature names</span>
    <span class="c1"># =============================================================================</span>
    
<div class="viewcode-block" id="visualizationClass.bar_plot">
<a class="viewcode-back" href="../../../XPER.viz.html#XPER.viz.Visualisation.visualizationClass.bar_plot">[docs]</a>
    <span class="k">def</span> <span class="nf">bar_plot</span><span class="p">(</span><span class="n">XPER_values</span><span class="p">,</span><span class="n">p</span><span class="p">,</span> <span class="n">X_test</span><span class="p">,</span><span class="n">labels</span><span class="p">,</span> <span class="n">percentage</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
    <span class="c1">#def bar_plot(XPER_values,labels,percentage=True):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Create a bar plot to visualize contributions.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        XPER_values : numpy.ndarray</span>
<span class="sd">            Array of contributions.</span>
<span class="sd">        X_test : pandas.DataFrame</span>
<span class="sd">            Test data used for labeling the plot.</span>
<span class="sd">        labels : list</span>
<span class="sd">            List of labels for the contributions.</span>
<span class="sd">        p : int</span>
<span class="sd">            Number of top contributions to display.</span>
<span class="sd">        percentage : bool, optional</span>
<span class="sd">            If True, contributions are shown as percentages. Default is True.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        None</span>

<span class="sd">        Examples</span>
<span class="sd">        --------</span>
<span class="sd">        &gt;&gt;&gt; import numpy as np</span>
<span class="sd">        &gt;&gt;&gt; import pandas as pd</span>
<span class="sd">        &gt;&gt;&gt; import plotly.graph_objects as go</span>
<span class="sd">        &gt;&gt;&gt; import plotly.express as px</span>
<span class="sd">        &gt;&gt;&gt; XPER_values = np.array([0.2, 0.3, 0.5])</span>
<span class="sd">        &gt;&gt;&gt; X_test = pd.DataFrame({&#39;A&#39;: [1, 2, 3], &#39;B&#39;: [4, 5, 6], &#39;C&#39;: [7, 8, 9]})</span>
<span class="sd">        &gt;&gt;&gt; labels = [&#39;Label 1&#39;, &#39;Label 2&#39;, &#39;Label 3&#39;]</span>
<span class="sd">        &gt;&gt;&gt; p = 2</span>
<span class="sd">        &gt;&gt;&gt; bar_plot(XPER_values, X_test, labels, p)</span>

<span class="sd">        Notes</span>
<span class="sd">        -----</span>
<span class="sd">        This function creates a horizontal bar plot to visualize contributions. The contributions are provided as an array</span>
<span class="sd">        in `XPER_values`, which represents the contributions of each feature or metric. The `X_test` DataFrame is used to</span>
<span class="sd">        label the plot based on the column names. The `labels` list provides additional labels for the contributions.</span>
<span class="sd">        The `p` parameter determines the number of top contributions to display.</span>

<span class="sd">        If `percentage` is True, the contributions are shown as percentages of the total contribution. Otherwise, the</span>
<span class="sd">        contributions are displayed as absolute values.</span>

<span class="sd">        The plot is created using plotly.graph_objects and plotly.express libraries. The bars are colored using a gradient</span>
<span class="sd">        from RGB(249, 218, 37) to RGB(99, 2, 164). The y-axis displays the labels and the x-axis represents the contribution</span>
<span class="sd">        values. The plot is displayed using fig.show().</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">Contribution</span> <span class="o">=</span> <span class="n">XPER_values</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>

        <span class="n">ecart_contrib</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="n">Contribution</span><span class="p">)</span> <span class="o">-</span> <span class="n">Contribution</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

        <span class="k">if</span> <span class="n">percentage</span> <span class="o">==</span> <span class="kc">True</span><span class="p">:</span>
            <span class="n">Contribution</span> <span class="o">=</span> <span class="p">(</span><span class="n">Contribution</span> <span class="o">/</span> <span class="n">ecart_contrib</span><span class="p">)</span> <span class="o">*</span> <span class="mi">100</span>

            <span class="c1">#print(&quot;Contribution (%) sum: &quot;, sum(Contribution[1:]))</span>

        <span class="c1">#selection = pd.DataFrame(Contribution[1:], index=X_test.columns, columns=[&quot;Metric&quot;])</span>
        <span class="n">selection</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">Contribution</span><span class="p">[</span><span class="mi">1</span><span class="p">:],</span> <span class="n">index</span><span class="o">=</span><span class="n">X_test</span><span class="o">.</span><span class="n">columns</span><span class="p">,</span> <span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;Metric&quot;</span><span class="p">])</span>

        <span class="n">selection</span><span class="p">[</span><span class="s2">&quot;Labels&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">labels</span>

        <span class="n">selection</span><span class="p">[</span><span class="s2">&quot;absolute&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">abs</span><span class="p">(</span><span class="n">selection</span><span class="p">[</span><span class="s2">&quot;Metric&quot;</span><span class="p">])</span>

        <span class="n">testons</span> <span class="o">=</span> <span class="n">selection</span><span class="o">.</span><span class="n">sort_values</span><span class="p">(</span><span class="n">by</span><span class="o">=</span><span class="s2">&quot;absolute&quot;</span><span class="p">,</span> <span class="n">ascending</span><span class="o">=</span><span class="kc">False</span><span class="p">)[:</span><span class="n">p</span><span class="p">]</span><span class="o">.</span><span class="n">index</span>

        <span class="n">final_selection_values</span> <span class="o">=</span> <span class="n">selection</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">testons</span><span class="p">,</span> <span class="s2">&quot;Metric&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span>
        <span class="n">final_selection_labels</span> <span class="o">=</span> <span class="n">selection</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">testons</span><span class="p">,</span> <span class="s2">&quot;Labels&quot;</span><span class="p">]</span>

        <span class="n">colorscale</span> <span class="o">=</span> <span class="p">[[</span><span class="mi">0</span><span class="p">,</span> <span class="s1">&#39;rgb(255, 1, 82)&#39;</span><span class="p">],</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="s1">&#39;rgb(255, 1, 82)&#39;</span><span class="p">]]</span>

        <span class="n">fig</span> <span class="o">=</span> <span class="n">go</span><span class="o">.</span><span class="n">Figure</span><span class="p">()</span>
        <span class="n">fig</span><span class="o">.</span><span class="n">add_trace</span><span class="p">(</span><span class="n">go</span><span class="o">.</span><span class="n">Bar</span><span class="p">(</span>
            <span class="n">x</span><span class="o">=</span><span class="n">final_selection_values</span><span class="p">,</span>
            <span class="n">y</span><span class="o">=</span><span class="n">final_selection_labels</span><span class="p">,</span>
            <span class="n">orientation</span><span class="o">=</span><span class="s1">&#39;h&#39;</span><span class="p">,</span>
            <span class="n">marker</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span><span class="n">color</span><span class="o">=</span><span class="n">final_selection_values</span><span class="p">,</span> <span class="n">colorscale</span><span class="o">=</span><span class="n">colorscale</span><span class="p">)</span>
        <span class="p">))</span>

        <span class="k">if</span> <span class="n">percentage</span> <span class="o">==</span> <span class="kc">True</span><span class="p">:</span>
            <span class="n">fig</span><span class="o">.</span><span class="n">update_layout</span><span class="p">(</span><span class="n">xaxis_title</span><span class="o">=</span><span class="s1">&#39;Contribution&#39;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">fig</span><span class="o">.</span><span class="n">update_layout</span><span class="p">(</span><span class="n">xaxis_title</span><span class="o">=</span><span class="s1">&#39;Contribution&#39;</span><span class="p">)</span>

        <span class="n">fig</span><span class="o">.</span><span class="n">update_layout</span><span class="p">(</span>
            <span class="n">yaxis</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span><span class="n">autorange</span><span class="o">=</span><span class="s2">&quot;reversed&quot;</span><span class="p">),</span>
            <span class="n">showlegend</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
            <span class="n">plot_bgcolor</span><span class="o">=</span><span class="s1">&#39;white&#39;</span>
        <span class="p">)</span>

        <span class="n">fig</span><span class="o">.</span><span class="n">show</span><span class="p">()</span></div>


<div class="viewcode-block" id="visualizationClass.beeswarn_plot">
<a class="viewcode-back" href="../../../XPER.viz.html#XPER.viz.Visualisation.visualizationClass.beeswarn_plot">[docs]</a>
    <span class="k">def</span> <span class="nf">beeswarn_plot</span><span class="p">(</span><span class="n">XPER_values</span><span class="p">,</span><span class="n">X_test</span><span class="p">,</span><span class="n">labels</span><span class="p">):</span>
        
        <span class="n">XPER_v_ind</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">XPER_values</span><span class="p">[</span><span class="mi">1</span><span class="p">][:,</span><span class="mi">1</span><span class="p">:])</span>
        
        <span class="n">benchmark_v_ind</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">XPER_values</span><span class="p">[</span><span class="mi">1</span><span class="p">][:,</span><span class="mi">0</span><span class="p">],</span><span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;Individual Benchmark&quot;</span><span class="p">])</span>
        
        <span class="c1"># =============================================================================</span>
        <span class="c1">#                       Prerequisites for the use of SHAP plots </span>
        <span class="c1"># =============================================================================</span>

        <span class="kn">import</span> <span class="nn">xgboost</span>
        <span class="kn">import</span> <span class="nn">shap</span>

        <span class="c1">### Idea: We use SHAP on a given model and then we change the values, data, </span>
        <span class="c1">### feature_names, base_values to the one obtained with XPER. Therefore, we</span>
        <span class="c1">### are able to use the shap plots from the shap package on our results from XPER.</span>

        <span class="c1"># train XGBoost model</span>
        <span class="n">X_useless</span><span class="p">,</span><span class="n">y_useless</span> <span class="o">=</span> <span class="n">shap</span><span class="o">.</span><span class="n">datasets</span><span class="o">.</span><span class="n">adult</span><span class="p">()</span>

        <span class="n">X_useless</span> <span class="o">=</span> <span class="n">X_useless</span><span class="o">.</span><span class="n">iloc</span><span class="p">[:</span><span class="mi">100</span><span class="p">,:]</span>
        <span class="n">y_useless</span> <span class="o">=</span> <span class="n">y_useless</span><span class="p">[:</span><span class="mi">100</span><span class="p">]</span>

        <span class="n">model</span> <span class="o">=</span> <span class="n">xgboost</span><span class="o">.</span><span class="n">XGBClassifier</span><span class="p">()</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">X_useless</span><span class="p">,</span> <span class="n">y_useless</span><span class="p">)</span>

        <span class="c1"># compute SHAP values</span>
        <span class="n">explainer</span> <span class="o">=</span> <span class="n">shap</span><span class="o">.</span><span class="n">Explainer</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">X_useless</span><span class="p">)</span>
        <span class="n">shap_values</span> <span class="o">=</span> <span class="n">explainer</span><span class="p">(</span><span class="n">X_useless</span><span class="p">)</span>   <span class="c1"># This is the object of interests for which</span>
                                              <span class="c1"># we are going to the change the values to </span>
                                              <span class="c1"># those of XPER.</span>
                                              
        <span class="c1"># ########################## phi_i_j contributions ##############################</span>
        <span class="c1"># ##########################     Beeswarn plot     ##############################</span>


        <span class="c1">#### Now we change the values of &quot;shap_values&quot; to those of XPER</span>

        <span class="n">df_phi_i_j</span> <span class="o">=</span> <span class="n">XPER_v_ind</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>

        <span class="n">shap_values</span><span class="o">.</span><span class="n">values</span> <span class="o">=</span> <span class="n">df_phi_i_j</span><span class="o">.</span><span class="n">to_numpy</span><span class="p">()</span>  <span class="c1"># XPER values for each observation</span>
                                                    <span class="c1"># and for each feature </span>
        <span class="n">shap_values</span><span class="o">.</span><span class="n">base_values</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">benchmark_v_ind</span><span class="o">.</span><span class="n">to_numpy</span><span class="p">(),</span><span class="n">benchmark_v_ind</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
                                                    <span class="c1"># Base_value = benchmark values</span>
        <span class="n">shap_values</span><span class="o">.</span><span class="n">data</span> <span class="o">=</span> <span class="n">X_test</span>                   <span class="c1"># Data/Inputs</span>

        <span class="n">shap_values</span><span class="o">.</span><span class="n">feature_names</span> <span class="o">=</span> <span class="n">labels</span>   <span class="c1"># Label of the features displayed on</span>
                                                    <span class="c1"># the y-axis</span>


        <span class="c1"># ##### Summary plots</span>

        <span class="n">ordering</span> <span class="o">=</span> <span class="n">shap_values</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>              <span class="c1"># By default the features are ordered</span>
                                                    <span class="c1"># using shap_values.abs.mean(0). We</span>
                                                    <span class="c1"># change it to the mean value of the</span>
                                                    <span class="c1"># XPER values = phi_j (global ones)</span>
        <span class="c1">#custom_green = &#39;#1da658&#39;</span>
        <span class="n">shap</span><span class="o">.</span><span class="n">plots</span><span class="o">.</span><span class="n">beeswarm</span><span class="p">(</span><span class="n">shap_values</span><span class="p">,</span> <span class="n">order</span><span class="o">=</span><span class="n">ordering</span><span class="p">,</span><span class="n">show</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s2">&quot;Contribution&quot;</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span></div>


        
    <span class="c1"># =============================================================================</span>
    <span class="c1">#                                   Force plots</span>
    <span class="c1"># =============================================================================</span>
        
    <span class="n">plt</span><span class="o">.</span><span class="n">rcParams</span><span class="p">[</span><span class="s2">&quot;figure.figsize&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="mf">7.00</span><span class="p">,</span> <span class="mf">3.50</span><span class="p">]</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">rcParams</span><span class="p">[</span><span class="s2">&quot;figure.autolayout&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>
    
    
<div class="viewcode-block" id="visualizationClass.draw_higher_lower_element">
<a class="viewcode-back" href="../../../XPER.viz.html#XPER.viz.Visualisation.visualizationClass.draw_higher_lower_element">[docs]</a>
    <span class="k">def</span> <span class="nf">draw_higher_lower_element</span><span class="p">(</span><span class="n">out_value</span><span class="p">,</span> <span class="n">offset_text</span><span class="p">):</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">text</span><span class="p">(</span><span class="n">out_value</span> <span class="o">-</span> <span class="n">offset_text</span><span class="p">,</span> <span class="mf">0.495</span><span class="p">,</span> <span class="s1">&#39;higher&#39;</span><span class="p">,</span>
                 <span class="n">fontsize</span><span class="o">=</span><span class="mi">13</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;#ff0152&#39;</span><span class="p">,</span>
                 <span class="n">horizontalalignment</span><span class="o">=</span><span class="s1">&#39;right&#39;</span><span class="p">)</span>
    
        <span class="n">plt</span><span class="o">.</span><span class="n">text</span><span class="p">(</span><span class="n">out_value</span> <span class="o">+</span> <span class="n">offset_text</span><span class="p">,</span> <span class="mf">0.495</span><span class="p">,</span> <span class="s1">&#39;lower&#39;</span><span class="p">,</span>
                 <span class="n">fontsize</span><span class="o">=</span><span class="mi">13</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;#0189fa&#39;</span><span class="p">,</span>
                 <span class="n">horizontalalignment</span><span class="o">=</span><span class="s1">&#39;left&#39;</span><span class="p">)</span>
        
        <span class="n">plt</span><span class="o">.</span><span class="n">text</span><span class="p">(</span><span class="n">out_value</span><span class="p">,</span> <span class="mf">0.49</span><span class="p">,</span> <span class="sa">r</span><span class="s1">&#39;$\leftarrow$&#39;</span><span class="p">,</span>
                 <span class="n">fontsize</span><span class="o">=</span><span class="mi">13</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;#0189fa&#39;</span><span class="p">,</span>
                 <span class="n">horizontalalignment</span><span class="o">=</span><span class="s1">&#39;center&#39;</span><span class="p">)</span>
        
        <span class="n">plt</span><span class="o">.</span><span class="n">text</span><span class="p">(</span><span class="n">out_value</span><span class="p">,</span> <span class="mf">0.515</span><span class="p">,</span> <span class="sa">r</span><span class="s1">&#39;$\rightarrow$&#39;</span><span class="p">,</span>
                 <span class="n">fontsize</span><span class="o">=</span><span class="mi">13</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;#ff0152&#39;</span><span class="p">,</span>
                 <span class="n">horizontalalignment</span><span class="o">=</span><span class="s1">&#39;center&#39;</span><span class="p">)</span></div>

        
<div class="viewcode-block" id="visualizationClass.force_plot">
<a class="viewcode-back" href="../../../XPER.viz.html#XPER.viz.Visualisation.visualizationClass.force_plot">[docs]</a>
    <span class="k">def</span> <span class="nf">force_plot</span><span class="p">(</span><span class="n">XPER_values</span><span class="p">,</span><span class="n">instance</span><span class="p">,</span> <span class="n">X_test</span><span class="p">,</span> <span class="n">variable_name</span><span class="p">,</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">8</span><span class="p">,</span><span class="mi">4</span><span class="p">),</span><span class="n">min_perc</span><span class="o">=</span><span class="mf">0.00001</span><span class="p">):</span>
        
        
        <span class="n">ind_i</span> <span class="o">=</span> <span class="n">instance</span>
        
        <span class="n">XPER_v_ind</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">XPER_values</span><span class="p">[</span><span class="mi">1</span><span class="p">][:,</span><span class="mi">1</span><span class="p">:])</span>
        
        <span class="n">benchmark_v_ind</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">XPER_values</span><span class="p">[</span><span class="mi">1</span><span class="p">][:,</span><span class="mi">0</span><span class="p">],</span><span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;Individual Benchmark&quot;</span><span class="p">])</span>
        
        
        
        <span class="n">XPER</span> <span class="o">=</span> <span class="n">XPER_v_ind</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="n">ind_i</span><span class="p">]</span><span class="o">.</span><span class="n">values</span> 
        
        <span class="n">benchmark_ind_i</span> <span class="o">=</span> <span class="n">benchmark_v_ind</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="n">ind_i</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> 
        
        <span class="n">perf_value_ind</span> <span class="o">=</span> <span class="n">XPER_v_ind</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span> <span class="o">+</span> <span class="n">benchmark_ind_i</span>
            <span class="c1"># The individual performance metric value is equal to the sum of the </span>
            <span class="c1"># XPER values </span>

        <span class="n">perf_value_ind</span> <span class="o">=</span> <span class="nb">round</span><span class="p">(</span><span class="n">perf_value_ind</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="n">ind_i</span><span class="p">],</span><span class="mi">2</span><span class="p">)</span> 
            <span class="c1"># We pick the value of the individual performance metric value for individual</span>
            <span class="c1"># &quot;ind_i&quot; and we round the number to the 2nd decimal.</span>
            
        <span class="n">X</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="n">X_test</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="n">ind_i</span><span class="p">,:],</span><span class="mi">3</span><span class="p">),</span><span class="n">index</span><span class="o">=</span><span class="n">variable_name</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">object</span><span class="p">)</span>
            <span class="c1"># Feature values of individual &quot;ind_i&quot; in a pandas series object with the</span>
            <span class="c1"># index being equal to the name of the variable (&quot;variable_name&quot;). </span>
            <span class="c1"># Dtype object allows to have both integers and floats on the same pandas series</span>

        <span class="n">X_names</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">variable_name</span><span class="p">)</span> 
            <span class="c1"># Numpy array with the name of the variables (&quot;variable_name&quot;)</span>
            <span class="c1"># It needs to be a numpy array.</span>
        
        <span class="n">base_value</span> <span class="o">=</span> <span class="n">benchmark_ind_i</span>
        
        <span class="n">perf_value</span> <span class="o">=</span> <span class="n">perf_value_ind</span>
      
        
        <span class="c1">#======================================================================        </span>
        <span class="c1">#======================================================================</span>
        <span class="c1">#======================================================================    </span>
        
        <span class="c1"># On ne prend pas volontairement le 0 en compte car aucun apport d&#39;info</span>
        <span class="n">pos_values</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="nb">sorted</span><span class="p">(</span><span class="n">XPER</span><span class="p">[</span><span class="n">XPER</span><span class="o">&gt;</span><span class="mi">0</span><span class="p">],</span><span class="n">reverse</span><span class="o">=</span><span class="kc">True</span><span class="p">))</span>
        <span class="n">neg_values</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="nb">sorted</span><span class="p">(</span><span class="n">XPER</span><span class="p">[</span><span class="n">XPER</span><span class="o">&lt;</span><span class="mi">0</span><span class="p">],</span><span class="n">reverse</span><span class="o">=</span><span class="kc">False</span><span class="p">))</span>
    
        <span class="c1">#####</span>
        
        <span class="n">index_sort_pos</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">argsort</span><span class="p">(</span><span class="o">-</span><span class="n">XPER</span><span class="p">[</span><span class="n">XPER</span><span class="o">&gt;</span><span class="mi">0</span><span class="p">])</span> <span class="c1"># signe - car on index ensuite par les variables les plus importantes</span>
    
        
        <span class="n">index_sort_neg</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">argsort</span><span class="p">(</span><span class="n">XPER</span><span class="p">[</span><span class="n">XPER</span><span class="o">&lt;</span><span class="mi">0</span><span class="p">])</span> <span class="c1"># signe - car ordonne par ordre croissant</span>
    
        <span class="c1">#####</span>
    
        <span class="n">offset_text</span> <span class="o">=</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">pos_values</span><span class="o">.</span><span class="n">sum</span><span class="p">())</span> <span class="o">+</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">neg_values</span><span class="o">.</span><span class="n">sum</span><span class="p">()))</span> <span class="o">*</span> <span class="mf">0.01</span>
        
        <span class="c1">#print(&quot;Here&quot;,perf_value,pos_values.sum())</span>
        <span class="n">x_min</span> <span class="o">=</span> <span class="n">perf_value</span> <span class="o">-</span> <span class="n">pos_values</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span><span class="c1"># axe sont inverses </span>
        <span class="n">x_max</span> <span class="o">=</span> <span class="n">perf_value</span> <span class="o">+</span> <span class="p">(</span><span class="o">-</span><span class="n">neg_values</span><span class="o">.</span><span class="n">sum</span><span class="p">())</span>  <span class="c1"># axe sont inverses </span>
            
        <span class="c1"># Define plots</span>
        <span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="n">figsize</span><span class="p">)</span>
    
        <span class="c1"># Plot height</span>
        <span class="n">height</span> <span class="o">=</span> <span class="mf">0.13</span>
        <span class="n">base_height</span> <span class="o">=</span> <span class="mf">0.03</span>
    
        <span class="c1"># Plot limits</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">xlim</span><span class="p">([</span><span class="n">x_min</span><span class="o">-</span><span class="mf">0.05</span><span class="p">,</span><span class="n">x_max</span><span class="o">+</span><span class="mf">0.075</span><span class="p">])</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">ylim</span><span class="p">([</span><span class="o">-</span><span class="mf">0.5</span><span class="p">,</span><span class="mf">0.15</span><span class="p">])</span>
    
        <span class="c1"># Width separator </span>
        <span class="k">global</span> <span class="n">width_separators</span>
        <span class="n">width_separators</span> <span class="o">=</span> <span class="p">(</span><span class="n">ax</span><span class="o">.</span><span class="n">get_xlim</span><span class="p">()[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">ax</span><span class="o">.</span><span class="n">get_xlim</span><span class="p">()[</span><span class="mi">0</span><span class="p">])</span> <span class="o">/</span> <span class="mi">200</span>
    
        <span class="c1">#for values in pos_values: # Iteration sur les XPER positives</span>
        <span class="n">base_x</span> <span class="o">=</span> <span class="n">perf_value</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        
        <span class="n">fleche</span> <span class="o">=</span> <span class="n">XPER</span><span class="o">.</span><span class="n">max</span><span class="p">()</span> <span class="o">/</span><span class="mi">30</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span><span class="n">values</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">pos_values</span><span class="p">):</span> <span class="c1"># Iteration sur les XPER positives</span>
        
            
            <span class="k">if</span> <span class="n">i</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                
                <span class="c1"># Forme polygon</span>
                <span class="n">cut_y</span> <span class="o">=</span> <span class="mf">0.08</span> <span class="c1"># fix </span>
                <span class="n">cut_x</span> <span class="o">=</span> <span class="n">values</span> <span class="o">-</span> <span class="n">fleche</span> <span class="c1"># variables</span>
                     
                <span class="c1">### Polygon de separation avant le vrai polygon </span>
                <span class="n">polygon_sep</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">Polygon</span><span class="p">([</span>
                               <span class="p">(</span><span class="n">base_x</span> <span class="o">-</span> <span class="n">cut_x</span> <span class="o">-</span> <span class="n">width_separators</span><span class="p">,</span> <span class="n">cut_y</span><span class="p">),</span>
                               <span class="p">(</span><span class="n">base_x</span> <span class="o">-</span> <span class="n">values</span> <span class="o">-</span> <span class="n">width_separators</span><span class="p">,</span> <span class="n">height</span><span class="p">),</span>
                               <span class="p">(</span><span class="n">base_x</span><span class="p">,</span> <span class="n">height</span><span class="p">),</span>
                               <span class="p">(</span><span class="n">base_x</span><span class="p">,</span> <span class="n">base_height</span><span class="p">),</span>
                               <span class="p">(</span><span class="n">base_x</span> <span class="o">-</span> <span class="n">values</span> <span class="o">-</span> <span class="n">width_separators</span><span class="p">,</span> <span class="n">base_height</span><span class="p">),</span>
                               <span class="p">(</span><span class="n">base_x</span> <span class="o">-</span> <span class="n">cut_x</span> <span class="o">-</span> <span class="n">width_separators</span><span class="p">,</span> <span class="n">cut_y</span><span class="p">)</span>
                            <span class="p">],</span> <span class="n">closed</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">fill</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span><span class="n">facecolor</span><span class="o">=</span><span class="s2">&quot;#f990b2&quot;</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span> <span class="c1">#  &quot;#FFC3D5&quot;</span>
                            
                <span class="n">plt</span><span class="o">.</span><span class="n">gca</span><span class="p">()</span><span class="o">.</span><span class="n">add_patch</span><span class="p">(</span><span class="n">polygon_sep</span><span class="p">)</span>
                                 
                <span class="n">polygon</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">Polygon</span><span class="p">([</span>
                               <span class="p">(</span><span class="n">base_x</span> <span class="o">-</span> <span class="n">cut_x</span><span class="p">,</span> <span class="n">cut_y</span><span class="p">),</span>
                               <span class="p">(</span><span class="n">base_x</span> <span class="o">-</span> <span class="n">values</span><span class="p">,</span> <span class="n">height</span><span class="p">),</span>
                               <span class="p">(</span><span class="n">base_x</span><span class="p">,</span> <span class="n">height</span><span class="p">),</span>
                               <span class="p">(</span><span class="n">base_x</span><span class="p">,</span> <span class="n">base_height</span><span class="p">),</span>
                               <span class="p">(</span><span class="n">base_x</span> <span class="o">-</span> <span class="n">values</span><span class="p">,</span> <span class="n">base_height</span><span class="p">),</span>
                               <span class="p">(</span><span class="n">base_x</span> <span class="o">-</span> <span class="n">cut_x</span><span class="p">,</span> <span class="n">cut_y</span><span class="p">)</span>
                            <span class="p">],</span> <span class="n">closed</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">fill</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span><span class="n">facecolor</span><span class="o">=</span><span class="s2">&quot;#ff0152&quot;</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span> <span class="c1">#  &quot;#FF0D57&quot;</span>
                            
                <span class="n">plt</span><span class="o">.</span><span class="n">gca</span><span class="p">()</span><span class="o">.</span><span class="n">add_patch</span><span class="p">(</span><span class="n">polygon</span><span class="p">)</span>
     
            <span class="k">else</span><span class="p">:</span>
                
                <span class="c1"># Forme polygon </span>
                <span class="n">cut_y</span> <span class="o">=</span> <span class="mf">0.08</span> <span class="c1"># fix </span>
                <span class="n">cut_x</span> <span class="o">=</span> <span class="n">values</span> <span class="o">-</span> <span class="n">fleche</span>  <span class="c1"># variables</span>
                
                          
                            <span class="c1">### Polygon de separation avant le vrai polygon </span>
                <span class="n">polygon_sep</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">Polygon</span><span class="p">([</span>
                            <span class="p">(</span><span class="n">ancien_cut_x</span> <span class="o">-</span> <span class="n">width_separators</span><span class="p">,</span> <span class="n">cut_y</span><span class="p">),</span>
                            <span class="p">(</span><span class="n">base_x</span> <span class="o">-</span> <span class="n">width_separators</span><span class="p">,</span><span class="n">height</span><span class="p">),</span>
                            <span class="p">(</span><span class="n">base_x</span> <span class="o">-</span> <span class="n">values</span> <span class="o">-</span> <span class="n">width_separators</span><span class="p">,</span> <span class="n">height</span><span class="p">),</span>
                            <span class="p">(</span><span class="n">base_x</span> <span class="o">-</span> <span class="n">cut_x</span> <span class="o">-</span> <span class="n">width_separators</span><span class="p">,</span> <span class="n">cut_y</span><span class="p">),</span>
                            <span class="p">(</span><span class="n">base_x</span> <span class="o">-</span> <span class="n">values</span> <span class="o">-</span> <span class="n">width_separators</span> <span class="p">,</span> <span class="n">base_height</span><span class="p">),</span>
                            <span class="p">(</span><span class="n">base_x</span> <span class="o">-</span> <span class="n">width_separators</span><span class="p">,</span><span class="n">base_height</span><span class="p">),</span>
                            <span class="p">(</span><span class="n">ancien_cut_x</span><span class="o">-</span> <span class="n">width_separators</span><span class="p">,</span> <span class="n">cut_y</span><span class="p">)],</span> 
                            <span class="n">closed</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">fill</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span><span class="n">facecolor</span><span class="o">=</span><span class="s2">&quot;#f990b2&quot;</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span> <span class="c1">#  &quot;#FFC3D5&quot;</span>
                            
                <span class="n">plt</span><span class="o">.</span><span class="n">gca</span><span class="p">()</span><span class="o">.</span><span class="n">add_patch</span><span class="p">(</span><span class="n">polygon_sep</span><span class="p">)</span>
                       
                <span class="n">polygon</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">Polygon</span><span class="p">([</span>
                            <span class="p">(</span><span class="n">ancien_cut_x</span><span class="p">,</span> <span class="n">cut_y</span><span class="p">),</span>
                            <span class="p">(</span><span class="n">base_x</span><span class="p">,</span><span class="n">height</span><span class="p">),</span>
                            <span class="p">(</span><span class="n">base_x</span> <span class="o">-</span> <span class="n">values</span><span class="p">,</span> <span class="n">height</span><span class="p">),</span>
                            <span class="p">(</span><span class="n">base_x</span> <span class="o">-</span> <span class="n">cut_x</span> <span class="p">,</span> <span class="n">cut_y</span><span class="p">),</span>
                            <span class="p">(</span><span class="n">base_x</span> <span class="o">-</span> <span class="n">values</span> <span class="p">,</span> <span class="n">base_height</span><span class="p">),</span>
                            <span class="p">(</span><span class="n">base_x</span> <span class="p">,</span><span class="n">base_height</span><span class="p">),</span>
                            <span class="p">(</span><span class="n">ancien_cut_x</span><span class="p">,</span> <span class="n">cut_y</span><span class="p">)],</span>
                                <span class="n">closed</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">fill</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span><span class="n">facecolor</span><span class="o">=</span><span class="s2">&quot;#ff0152&quot;</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span> <span class="c1">#  &quot;#FF0D57&quot;</span>
                
                <span class="n">plt</span><span class="o">.</span><span class="n">gca</span><span class="p">()</span><span class="o">.</span><span class="n">add_patch</span><span class="p">(</span><span class="n">polygon</span><span class="p">)</span>    
            
            
            <span class="n">ancien_cut_x</span> <span class="o">=</span> <span class="n">base_x</span> <span class="o">-</span> <span class="n">cut_x</span> <span class="o">-</span> <span class="n">width_separators</span>
            <span class="c1"># Changement depart de l&#39;axe des abscisses </span>
            <span class="n">base_x</span> <span class="o">+=</span>  <span class="o">-</span> <span class="n">values</span> <span class="o">-</span> <span class="n">width_separators</span>       
        
        <span class="n">fig</span><span class="p">,</span><span class="n">ax</span> <span class="o">=</span> <span class="n">visualizationClass</span><span class="o">.</span><span class="n">draw_labels</span><span class="p">(</span><span class="n">fig</span><span class="o">=</span><span class="n">fig</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">,</span> <span class="n">perf_value</span><span class="o">=</span><span class="n">perf_value</span><span class="p">,</span><span class="n">features</span><span class="o">=</span><span class="n">pos_values</span><span class="p">,</span> 
                                     <span class="n">feature_type</span><span class="o">=</span><span class="s2">&quot;positive&quot;</span><span class="p">,</span> <span class="n">X</span><span class="o">=</span><span class="n">X</span><span class="p">[</span><span class="n">XPER</span><span class="o">&gt;</span><span class="mi">0</span><span class="p">][</span><span class="n">index_sort_pos</span><span class="p">],</span> <span class="n">X_names</span><span class="o">=</span><span class="n">X_names</span><span class="p">[</span><span class="n">XPER</span><span class="o">&gt;</span><span class="mi">0</span><span class="p">][</span><span class="n">index_sort_pos</span><span class="p">],</span>
                            <span class="n">offset_text</span><span class="o">=</span><span class="n">offset_text</span><span class="p">,</span> <span class="n">min_perc</span><span class="o">=</span><span class="n">min_perc</span><span class="p">,</span> <span class="n">text_rotation</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
               
        <span class="n">base_x</span> <span class="o">=</span> <span class="n">perf_value</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span><span class="n">values</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">neg_values</span><span class="p">):</span> <span class="c1"># Iteration sur les XPER negatives</span>
        
            <span class="n">values</span> <span class="o">=</span> <span class="o">-</span><span class="n">values</span> 
            <span class="k">if</span> <span class="n">i</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                
                <span class="c1"># Forme polygon</span>
                <span class="n">cut_y</span> <span class="o">=</span> <span class="mf">0.08</span> <span class="c1"># fix </span>
                <span class="n">cut_x</span> <span class="o">=</span> <span class="n">values</span> <span class="o">-</span> <span class="n">fleche</span> <span class="c1"># variables</span>
                            
                <span class="c1">### Polygon de separation avant le vrai polygon </span>
                <span class="n">polygon_sep</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">Polygon</span><span class="p">([</span>
                               <span class="p">(</span><span class="n">base_x</span> <span class="o">+</span> <span class="n">cut_x</span> <span class="o">+</span> <span class="n">width_separators</span><span class="p">,</span> <span class="n">cut_y</span><span class="p">),</span>
                               <span class="p">(</span><span class="n">base_x</span> <span class="o">+</span> <span class="n">values</span> <span class="o">+</span> <span class="n">width_separators</span><span class="p">,</span> <span class="n">height</span><span class="p">),</span>
                               <span class="p">(</span><span class="n">base_x</span><span class="p">,</span> <span class="n">height</span><span class="p">),</span>
                               <span class="p">(</span><span class="n">base_x</span><span class="p">,</span> <span class="n">base_height</span><span class="p">),</span>
                               <span class="p">(</span><span class="n">base_x</span> <span class="o">+</span> <span class="n">values</span> <span class="o">+</span> <span class="n">width_separators</span><span class="p">,</span> <span class="n">base_height</span><span class="p">),</span>
                               <span class="p">(</span><span class="n">base_x</span> <span class="o">+</span> <span class="n">cut_x</span> <span class="o">+</span> <span class="n">width_separators</span><span class="p">,</span> <span class="n">cut_y</span><span class="p">)</span>
                            <span class="p">],</span> <span class="n">closed</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">fill</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span><span class="n">facecolor</span><span class="o">=</span><span class="s2">&quot;#8fc8f7&quot;</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span> <span class="c1">#  &quot;#D1E6FA&quot; </span>
                            
                <span class="n">plt</span><span class="o">.</span><span class="n">gca</span><span class="p">()</span><span class="o">.</span><span class="n">add_patch</span><span class="p">(</span><span class="n">polygon_sep</span><span class="p">)</span>
                                    
                <span class="n">polygon</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">Polygon</span><span class="p">([</span>
                               <span class="p">(</span><span class="n">base_x</span> <span class="o">+</span> <span class="n">cut_x</span><span class="p">,</span> <span class="n">cut_y</span><span class="p">),</span>
                               <span class="p">(</span><span class="n">base_x</span> <span class="o">+</span> <span class="n">values</span><span class="p">,</span> <span class="n">height</span><span class="p">),</span>
                               <span class="p">(</span><span class="n">base_x</span><span class="p">,</span> <span class="n">height</span><span class="p">),</span>
                               <span class="p">(</span><span class="n">base_x</span><span class="p">,</span> <span class="n">base_height</span><span class="p">),</span>
                               <span class="p">(</span><span class="n">base_x</span> <span class="o">+</span> <span class="n">values</span><span class="p">,</span> <span class="n">base_height</span><span class="p">),</span>
                               <span class="p">(</span><span class="n">base_x</span> <span class="o">+</span> <span class="n">cut_x</span><span class="p">,</span> <span class="n">cut_y</span><span class="p">)</span>
                            <span class="p">],</span> <span class="n">closed</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">fill</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span><span class="n">facecolor</span><span class="o">=</span><span class="s2">&quot;#0189fa&quot;</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span> <span class="c1">#  </span>
                            
                <span class="n">plt</span><span class="o">.</span><span class="n">gca</span><span class="p">()</span><span class="o">.</span><span class="n">add_patch</span><span class="p">(</span><span class="n">polygon</span><span class="p">)</span>
    
            <span class="k">else</span><span class="p">:</span>
                
                <span class="c1"># Forme polygon </span>
                <span class="n">cut_y</span> <span class="o">=</span> <span class="mf">0.08</span> <span class="c1"># fix </span>
                <span class="n">cut_x</span> <span class="o">=</span> <span class="n">values</span> <span class="o">-</span> <span class="n">fleche</span>  <span class="c1"># variables</span>
                
                           
                            <span class="c1">### Polygon de separation avant le vrai polygon </span>
                <span class="n">polygon_sep</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">Polygon</span><span class="p">([</span>
                            <span class="p">(</span><span class="n">ancien_cut_x</span> <span class="o">+</span> <span class="n">width_separators</span><span class="p">,</span> <span class="n">cut_y</span><span class="p">),</span>
                            <span class="p">(</span><span class="n">base_x</span> <span class="o">+</span> <span class="n">width_separators</span><span class="p">,</span><span class="n">height</span><span class="p">),</span>
                            <span class="p">(</span><span class="n">base_x</span> <span class="o">+</span> <span class="n">values</span> <span class="o">+</span> <span class="n">width_separators</span><span class="p">,</span> <span class="n">height</span><span class="p">),</span>
                            <span class="p">(</span><span class="n">base_x</span> <span class="o">+</span> <span class="n">cut_x</span> <span class="o">+</span> <span class="n">width_separators</span><span class="p">,</span> <span class="n">cut_y</span><span class="p">),</span>
                            <span class="p">(</span><span class="n">base_x</span> <span class="o">+</span> <span class="n">values</span> <span class="o">+</span> <span class="n">width_separators</span> <span class="p">,</span> <span class="n">base_height</span><span class="p">),</span>
                            <span class="p">(</span><span class="n">base_x</span> <span class="o">+</span> <span class="n">width_separators</span><span class="p">,</span><span class="n">base_height</span><span class="p">),</span>
                            <span class="p">(</span><span class="n">ancien_cut_x</span><span class="o">+</span> <span class="n">width_separators</span><span class="p">,</span> <span class="n">cut_y</span><span class="p">)],</span> 
                            <span class="n">closed</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">fill</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span><span class="n">facecolor</span><span class="o">=</span><span class="s2">&quot;#8fc8f7&quot;</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span> <span class="c1"># &quot;#FFC3D5&quot; &quot;#D1E6FA&quot;</span>
                            
                <span class="n">plt</span><span class="o">.</span><span class="n">gca</span><span class="p">()</span><span class="o">.</span><span class="n">add_patch</span><span class="p">(</span><span class="n">polygon_sep</span><span class="p">)</span>
                       
                <span class="n">polygon</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">Polygon</span><span class="p">([</span>
                            <span class="p">(</span><span class="n">ancien_cut_x</span><span class="p">,</span> <span class="n">cut_y</span><span class="p">),</span>
                            <span class="p">(</span><span class="n">base_x</span><span class="p">,</span><span class="n">height</span><span class="p">),</span>
                            <span class="p">(</span><span class="n">base_x</span> <span class="o">+</span> <span class="n">values</span><span class="p">,</span> <span class="n">height</span><span class="p">),</span>
                            <span class="p">(</span><span class="n">base_x</span> <span class="o">+</span> <span class="n">cut_x</span> <span class="p">,</span> <span class="n">cut_y</span><span class="p">),</span>
                            <span class="p">(</span><span class="n">base_x</span> <span class="o">+</span> <span class="n">values</span> <span class="p">,</span> <span class="n">base_height</span><span class="p">),</span>
                            <span class="p">(</span><span class="n">base_x</span> <span class="p">,</span><span class="n">base_height</span><span class="p">),</span>
                            <span class="p">(</span><span class="n">ancien_cut_x</span><span class="p">,</span> <span class="n">cut_y</span><span class="p">)],</span>
                                <span class="n">closed</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">fill</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span><span class="n">facecolor</span><span class="o">=</span><span class="s2">&quot;#0189fa&quot;</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span> <span class="c1">#  &quot;#1E88E5&quot;</span>
                
                <span class="n">plt</span><span class="o">.</span><span class="n">gca</span><span class="p">()</span><span class="o">.</span><span class="n">add_patch</span><span class="p">(</span><span class="n">polygon</span><span class="p">)</span>    
            
            <span class="n">ancien_cut_x</span> <span class="o">=</span> <span class="n">base_x</span> <span class="o">+</span> <span class="n">cut_x</span> <span class="o">+</span> <span class="n">width_separators</span>
            <span class="c1"># Changement depart de l&#39;axe des abscisses </span>
            <span class="n">base_x</span> <span class="o">+=</span> <span class="n">values</span> <span class="o">+</span> <span class="n">width_separators</span>   
        
        <span class="n">fig</span><span class="p">,</span><span class="n">ax</span> <span class="o">=</span> <span class="n">visualizationClass</span><span class="o">.</span><span class="n">draw_labels</span><span class="p">(</span><span class="n">fig</span><span class="o">=</span><span class="n">fig</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">,</span> <span class="n">perf_value</span><span class="o">=</span><span class="n">perf_value</span><span class="p">,</span><span class="n">features</span><span class="o">=</span><span class="n">neg_values</span><span class="p">,</span> 
                                     <span class="n">feature_type</span><span class="o">=</span><span class="s2">&quot;negative&quot;</span><span class="p">,</span> <span class="n">X</span><span class="o">=</span><span class="n">X</span><span class="p">[</span><span class="n">XPER</span><span class="o">&lt;</span><span class="mi">0</span><span class="p">][</span><span class="n">index_sort_neg</span><span class="p">],</span> <span class="n">X_names</span><span class="o">=</span><span class="n">X_names</span><span class="p">[</span><span class="n">XPER</span><span class="o">&lt;</span><span class="mi">0</span><span class="p">][</span><span class="n">index_sort_neg</span><span class="p">],</span>
                            <span class="n">offset_text</span><span class="o">=</span><span class="n">offset_text</span><span class="p">,</span> <span class="n">min_perc</span><span class="o">=</span><span class="n">min_perc</span><span class="p">,</span> <span class="n">text_rotation</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
               
        <span class="c1">## Barre pour situe l&#39;individual payoff   </span>
        <span class="n">x</span><span class="p">,</span> <span class="n">y</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([[</span><span class="n">base_value</span><span class="p">,</span> <span class="n">base_value</span><span class="p">],</span> <span class="p">[</span><span class="mf">0.13</span><span class="p">,</span> <span class="mf">0.33</span><span class="p">]])</span>
        <span class="n">line</span> <span class="o">=</span> <span class="n">lines</span><span class="o">.</span><span class="n">Line2D</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">lw</span><span class="o">=</span><span class="mf">2.</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;#F2F2F2&#39;</span><span class="p">)</span>
        <span class="n">line</span><span class="o">.</span><span class="n">set_clip_on</span><span class="p">(</span><span class="kc">False</span><span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">add_line</span><span class="p">(</span><span class="n">line</span><span class="p">)</span>
    
        <span class="c1"># Texte pour montrer individual payoff</span>
        <span class="n">text_out_val</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">text</span><span class="p">(</span><span class="n">base_value</span><span class="p">,</span> <span class="mf">0.38</span><span class="p">,</span> <span class="s1">&#39;Benchmark&#39;</span><span class="p">,</span> <span class="c1"># hauteur de 0.33</span>
                                    <span class="n">fontsize</span><span class="o">=</span><span class="mi">14</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span>
                                    <span class="n">horizontalalignment</span><span class="o">=</span><span class="s1">&#39;center&#39;</span><span class="p">)</span>
        <span class="n">text_out_val</span><span class="o">.</span><span class="n">set_bbox</span><span class="p">(</span><span class="nb">dict</span><span class="p">(</span><span class="n">facecolor</span><span class="o">=</span><span class="s1">&#39;white&#39;</span><span class="p">,</span> <span class="n">edgecolor</span><span class="o">=</span><span class="s1">&#39;white&#39;</span><span class="p">))</span>
        
        <span class="c1">## Barre pour situe la performance individuelle</span>
        <span class="n">x</span><span class="p">,</span> <span class="n">y</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([[</span><span class="n">perf_value</span><span class="p">,</span> <span class="n">perf_value</span><span class="p">],</span> <span class="p">[</span><span class="mf">0.13</span><span class="p">,</span> <span class="mf">0.15</span><span class="p">]])</span>
        <span class="n">line</span> <span class="o">=</span> <span class="n">lines</span><span class="o">.</span><span class="n">Line2D</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">lw</span><span class="o">=</span><span class="mf">2.</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;#F2F2F2&#39;</span><span class="p">)</span>
        <span class="n">line</span><span class="o">.</span><span class="n">set_clip_on</span><span class="p">(</span><span class="kc">False</span><span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">add_line</span><span class="p">(</span><span class="n">line</span><span class="p">)</span>
    
        <span class="c1"># Texte pour montrer individual payoff</span>
        <span class="n">text_out_val_PM</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">text</span><span class="p">(</span><span class="n">perf_value</span><span class="p">,</span> <span class="mf">0.38</span><span class="p">,</span> <span class="s1">&#39;Performance&#39;</span><span class="p">,</span> <span class="c1"># hauteur de 0.33</span>
                                    <span class="n">fontsize</span><span class="o">=</span><span class="mi">14</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span>
                                    <span class="n">horizontalalignment</span><span class="o">=</span><span class="s1">&#39;center&#39;</span><span class="p">)</span>
        <span class="n">text_out_val_PM</span><span class="o">.</span><span class="n">set_bbox</span><span class="p">(</span><span class="nb">dict</span><span class="p">(</span><span class="n">facecolor</span><span class="o">=</span><span class="s1">&#39;white&#39;</span><span class="p">,</span> <span class="n">edgecolor</span><span class="o">=</span><span class="s1">&#39;white&#39;</span><span class="p">))</span>
        
        <span class="c1"># Texte pour montrer individual payoff</span>
        
        <span class="n">x</span><span class="p">,</span> <span class="n">y</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([[</span><span class="n">perf_value</span><span class="p">,</span> <span class="n">perf_value</span><span class="p">],</span> <span class="p">[</span><span class="mf">0.13</span><span class="p">,</span> <span class="mf">0.26</span><span class="p">]])</span>
        <span class="n">line</span> <span class="o">=</span> <span class="n">lines</span><span class="o">.</span><span class="n">Line2D</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">lw</span><span class="o">=</span><span class="mf">2.</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;#F2F2F2&#39;</span><span class="p">)</span>
        <span class="n">line</span><span class="o">.</span><span class="n">set_clip_on</span><span class="p">(</span><span class="kc">False</span><span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">add_line</span><span class="p">(</span><span class="n">line</span><span class="p">)</span>
        
        <span class="n">text_out_val_PM</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">text</span><span class="p">(</span><span class="n">perf_value</span><span class="p">,</span> <span class="mf">0.29</span><span class="p">,</span> <span class="s1">&#39;</span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">perf_value</span><span class="p">),</span> <span class="c1"># hauteur de 0.33</span>
                                    <span class="n">fontsize</span><span class="o">=</span><span class="mi">16</span><span class="p">,</span>
                                    <span class="n">horizontalalignment</span><span class="o">=</span><span class="s1">&#39;center&#39;</span><span class="p">,</span> <span class="n">weight</span><span class="o">=</span><span class="s1">&#39;bold&#39;</span><span class="p">)</span>
        <span class="c1">#text_out_val_PM.set_bbox(dict(facecolor=&#39;white&#39;, edgecolor=&#39;white&#39;))</span>
        
        <span class="n">visualizationClass</span><span class="o">.</span><span class="n">draw_higher_lower_element</span><span class="p">(</span><span class="n">out_value</span><span class="o">=</span><span class="n">perf_value</span><span class="p">,</span> <span class="n">offset_text</span><span class="o">=</span><span class="n">offset_text</span><span class="p">)</span>
        
        
        <span class="c1"># Ticks at the top of the graphic + at the top of the axis</span>
        
        
    
        <span class="n">plt</span><span class="o">.</span><span class="n">tick_params</span><span class="p">(</span><span class="n">top</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">bottom</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">left</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">right</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> 
                        <span class="n">labelleft</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">labeltop</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">labelbottom</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">locator_params</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="s1">&#39;x&#39;</span><span class="p">,</span> <span class="n">nbins</span><span class="o">=</span><span class="mi">12</span><span class="p">)</span>
        
    
        <span class="c1"># Remove axis except the top </span>
        <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">spine</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">plt</span><span class="o">.</span><span class="n">gca</span><span class="p">()</span><span class="o">.</span><span class="n">spines</span><span class="o">.</span><span class="n">keys</span><span class="p">(),</span> <span class="n">plt</span><span class="o">.</span><span class="n">gca</span><span class="p">()</span><span class="o">.</span><span class="n">spines</span><span class="o">.</span><span class="n">values</span><span class="p">()):</span>
                <span class="k">if</span> <span class="n">key</span> <span class="o">!=</span> <span class="s1">&#39;top&#39;</span><span class="p">:</span>
                    <span class="n">spine</span><span class="o">.</span><span class="n">set_visible</span><span class="p">(</span><span class="kc">False</span><span class="p">)</span>
    
        <span class="c1">#plt.savefig(f&#39;./Figures/{savefig_name}.pdf&#39;, format=&#39;pdf&#39;, dpi = 1200)</span>
    
        <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>  </div>

            
        
    <span class="c1">##############################################################################</span>
    
<div class="viewcode-block" id="visualizationClass.draw_labels">
<a class="viewcode-back" href="../../../XPER.viz.html#XPER.viz.Visualisation.visualizationClass.draw_labels">[docs]</a>
    <span class="k">def</span> <span class="nf">draw_labels</span><span class="p">(</span><span class="n">fig</span><span class="p">,</span> <span class="n">ax</span><span class="p">,</span> <span class="n">perf_value</span><span class="p">,</span> <span class="n">features</span><span class="p">,</span> <span class="n">feature_type</span><span class="p">,</span> <span class="n">X</span><span class="p">,</span> <span class="n">X_names</span><span class="p">,</span>
                    <span class="n">offset_text</span><span class="p">,</span> <span class="n">min_perc</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span> <span class="n">text_rotation</span><span class="o">=</span><span class="mi">0</span><span class="p">):</span>
        
        <span class="n">start_text</span> <span class="o">=</span> <span class="n">perf_value</span>
        <span class="n">pre_val</span> <span class="o">=</span> <span class="n">perf_value</span>
        
        <span class="c1"># Define variables specific to positive and negative effect features</span>
        <span class="k">if</span> <span class="n">feature_type</span> <span class="o">==</span> <span class="s1">&#39;positive&#39;</span><span class="p">:</span>
            <span class="n">colors</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;#f990b2&#39;</span><span class="p">,</span> <span class="s1">&#39;#ff0152&#39;</span><span class="p">]</span> <span class="c1"># [&#39;#FF0D57&#39;, &#39;#FFC3D5&#39;] [&#39;#FF0D57&#39;, &#39;#FFC3D5&#39;]</span>
            <span class="n">alignement</span> <span class="o">=</span> <span class="s1">&#39;right&#39;</span>
            <span class="n">sign</span> <span class="o">=</span> <span class="mi">1</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">colors</span> <span class="o">=</span>  <span class="p">[</span><span class="s1">&#39;#8fc8f7&#39;</span><span class="p">,</span> <span class="s1">&#39;#0189fa&#39;</span><span class="p">]</span><span class="c1"># [&#39;#1E88E5&#39;, &#39;#D1E6FA&#39;]</span>
            <span class="n">alignement</span> <span class="o">=</span> <span class="s1">&#39;left&#39;</span>
            <span class="n">sign</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>
        
        <span class="c1"># Draw initial line</span>
        <span class="k">if</span> <span class="n">feature_type</span> <span class="o">==</span> <span class="s1">&#39;positive&#39;</span><span class="p">:</span>
            <span class="n">x</span><span class="p">,</span> <span class="n">y</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([[</span><span class="n">pre_val</span><span class="p">,</span> <span class="n">pre_val</span><span class="p">],</span> <span class="p">[</span><span class="mf">0.03</span><span class="p">,</span> <span class="o">-</span><span class="mf">0.18</span><span class="p">]])</span>
            <span class="n">line</span> <span class="o">=</span> <span class="n">lines</span><span class="o">.</span><span class="n">Line2D</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">lw</span><span class="o">=</span><span class="mf">1.</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="n">colors</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
            <span class="n">line</span><span class="o">.</span><span class="n">set_clip_on</span><span class="p">(</span><span class="kc">False</span><span class="p">)</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">add_line</span><span class="p">(</span><span class="n">line</span><span class="p">)</span>
            <span class="n">start_text</span> <span class="o">=</span> <span class="n">pre_val</span>
            
        <span class="c1">#Features contribution</span>
        <span class="n">feature_contribution</span> <span class="o">=</span> <span class="n">features</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">features</span><span class="p">)</span><span class="c1">#      np.abs(features/perf_value)</span>
        <span class="c1">#print(feature_contribution)</span>
        <span class="c1">#print(min_perc)</span>
        <span class="c1">#feature_contribution = feature_contribution[feature_contribution&gt;min_perc]</span>
        
        <span class="n">box_end</span> <span class="o">=</span> <span class="n">perf_value</span>
        <span class="n">val</span> <span class="o">=</span> <span class="n">perf_value</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span><span class="n">feature</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">features</span><span class="p">):</span>
            <span class="c1"># Exclude all labels that do not contribute at least min_perc to the total</span>
            <span class="k">if</span> <span class="n">feature_contribution</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">&lt;</span> <span class="n">min_perc</span><span class="p">:</span>
                <span class="c1">#print(&quot;break because of low contribution:&quot;,i)</span>
                <span class="c1">#print(&quot;feature contribution&quot;,feature_contribution[i])</span>
                <span class="c1">#print(&quot;spread&quot;,feature_contribution[i] &lt; min_perc)</span>
                <span class="k">break</span>
            
            <span class="c1"># Compute value for current feature</span>
            <span class="n">val</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">val</span> <span class="o">-</span> <span class="n">feature</span> <span class="o">-</span><span class="n">sign</span><span class="o">*</span><span class="n">width_separators</span><span class="p">)</span>
            <span class="c1"># Draw labels.</span>
            <span class="n">text</span> <span class="o">=</span> <span class="n">X_names</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">+</span> <span class="s2">&quot;=&quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">X</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
            
            <span class="k">if</span> <span class="n">text_rotation</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">va_alignment</span> <span class="o">=</span> <span class="s1">&#39;top&#39;</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">va_alignment</span> <span class="o">=</span> <span class="s1">&#39;baseline&#39;</span>
    
            <span class="n">text_out_val</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">text</span><span class="p">(</span><span class="n">start_text</span> <span class="o">-</span> <span class="n">sign</span> <span class="o">*</span> <span class="n">offset_text</span><span class="p">,</span>
                                    <span class="o">-</span><span class="mf">0.15</span><span class="p">,</span> <span class="n">text</span><span class="p">,</span>
                                    <span class="n">fontsize</span><span class="o">=</span><span class="mi">12</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="n">colors</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
                                    <span class="n">horizontalalignment</span><span class="o">=</span><span class="n">alignement</span><span class="p">,</span>
                                    <span class="n">va</span><span class="o">=</span><span class="n">va_alignment</span><span class="p">,</span>
                                    <span class="n">rotation</span><span class="o">=</span><span class="n">text_rotation</span><span class="p">)</span>
            <span class="n">text_out_val</span><span class="o">.</span><span class="n">set_bbox</span><span class="p">(</span><span class="nb">dict</span><span class="p">(</span><span class="n">facecolor</span><span class="o">=</span><span class="s1">&#39;none&#39;</span><span class="p">,</span> <span class="n">edgecolor</span><span class="o">=</span><span class="s1">&#39;none&#39;</span><span class="p">))</span>
    
            <span class="c1"># We need to draw the plot to be able to get the size of the</span>
            <span class="c1"># text box</span>
            <span class="n">fig</span><span class="o">.</span><span class="n">canvas</span><span class="o">.</span><span class="n">draw</span><span class="p">()</span>
            <span class="n">box_size</span> <span class="o">=</span> <span class="n">text_out_val</span><span class="o">.</span><span class="n">get_bbox_patch</span><span class="p">()</span><span class="o">.</span><span class="n">get_extents</span><span class="p">()</span>\
                                   <span class="o">.</span><span class="n">transformed</span><span class="p">(</span><span class="n">ax</span><span class="o">.</span><span class="n">transData</span><span class="o">.</span><span class="n">inverted</span><span class="p">())</span>
                                   
            <span class="k">if</span> <span class="n">feature_type</span> <span class="o">==</span> <span class="s1">&#39;positive&#39;</span><span class="p">:</span>
                <span class="n">box_end_</span> <span class="o">=</span> <span class="n">box_size</span><span class="o">.</span><span class="n">get_points</span><span class="p">()[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">box_end_</span> <span class="o">=</span> <span class="n">box_size</span><span class="o">.</span><span class="n">get_points</span><span class="p">()[</span><span class="mi">1</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
            
            <span class="c1"># If the feature goes over the side of the plot, we remove that label</span>
            <span class="c1"># and stop drawing labels</span>
            <span class="k">if</span> <span class="n">box_end_</span> <span class="o">&gt;</span> <span class="n">ax</span><span class="o">.</span><span class="n">get_xlim</span><span class="p">()[</span><span class="mi">1</span><span class="p">]:</span>
                <span class="c1">#print(&quot;box_end&quot;,box_end_)</span>
                <span class="n">text_out_val</span><span class="o">.</span><span class="n">remove</span><span class="p">()</span>
                <span class="k">break</span>
            
            <span class="c1"># Create end line</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">sign</span> <span class="o">*</span> <span class="n">box_end_</span><span class="p">)</span> <span class="o">&gt;</span> <span class="p">(</span><span class="n">sign</span> <span class="o">*</span> <span class="n">val</span><span class="p">):</span>
                <span class="n">x</span><span class="p">,</span> <span class="n">y</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([[</span><span class="n">val</span><span class="p">,</span> <span class="n">val</span><span class="p">],</span> <span class="p">[</span><span class="mf">0.03</span><span class="p">,</span> <span class="o">-</span><span class="mf">0.18</span><span class="p">]])</span>
                <span class="n">line</span> <span class="o">=</span> <span class="n">lines</span><span class="o">.</span><span class="n">Line2D</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">lw</span><span class="o">=</span><span class="mf">1.</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="n">colors</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
                <span class="n">line</span><span class="o">.</span><span class="n">set_clip_on</span><span class="p">(</span><span class="kc">False</span><span class="p">)</span>
                <span class="n">ax</span><span class="o">.</span><span class="n">add_line</span><span class="p">(</span><span class="n">line</span><span class="p">)</span>
                <span class="n">start_text</span> <span class="o">=</span> <span class="n">val</span>
                <span class="n">box_end</span> <span class="o">=</span> <span class="n">val</span>
    
            <span class="k">else</span><span class="p">:</span>
                <span class="n">box_end</span> <span class="o">=</span> <span class="n">box_end_</span> <span class="o">-</span> <span class="n">sign</span> <span class="o">*</span> <span class="n">offset_text</span>
                <span class="n">x</span><span class="p">,</span> <span class="n">y</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([[</span><span class="n">val</span><span class="p">,</span> <span class="n">box_end</span><span class="p">,</span> <span class="n">box_end</span><span class="p">],</span>
                                 <span class="p">[</span><span class="mf">0.03</span><span class="p">,</span> <span class="o">-</span><span class="mf">0.08</span><span class="p">,</span> <span class="o">-</span><span class="mf">0.18</span><span class="p">]])</span>
                <span class="n">line</span> <span class="o">=</span> <span class="n">lines</span><span class="o">.</span><span class="n">Line2D</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">lw</span><span class="o">=</span><span class="mf">1.</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="n">colors</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
                <span class="n">line</span><span class="o">.</span><span class="n">set_clip_on</span><span class="p">(</span><span class="kc">False</span><span class="p">)</span>
                <span class="n">ax</span><span class="o">.</span><span class="n">add_line</span><span class="p">(</span><span class="n">line</span><span class="p">)</span>
                <span class="n">start_text</span> <span class="o">=</span> <span class="n">box_end</span>
            
            <span class="c1"># Update previous value</span>
            <span class="n">pre_val</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">pre_val</span> <span class="o">-</span><span class="n">feature</span> <span class="o">-</span><span class="n">sign</span><span class="o">*</span><span class="n">width_separators</span><span class="p">)</span>
    
        <span class="c1"># Create line for labels</span>
        <span class="n">extent_shading</span> <span class="o">=</span> <span class="p">[</span><span class="n">perf_value</span><span class="p">,</span> <span class="n">box_end</span><span class="p">,</span> <span class="mf">0.03</span><span class="p">,</span> <span class="o">-</span><span class="mf">0.31</span><span class="p">]</span>
        <span class="n">path</span> <span class="o">=</span> <span class="p">[[</span><span class="n">perf_value</span><span class="p">,</span> <span class="mf">0.03</span><span class="p">],</span> <span class="p">[</span><span class="n">pre_val</span><span class="p">,</span> <span class="mf">0.03</span><span class="p">],</span> <span class="p">[</span><span class="n">box_end</span><span class="p">,</span> <span class="o">-</span><span class="mf">0.08</span><span class="p">],</span>
                <span class="p">[</span><span class="n">box_end</span><span class="p">,</span> <span class="o">-</span><span class="mf">0.2</span><span class="p">],</span> <span class="p">[</span><span class="n">perf_value</span><span class="p">,</span> <span class="o">-</span><span class="mf">0.2</span><span class="p">],</span>
                <span class="p">[</span><span class="n">perf_value</span><span class="p">,</span> <span class="mf">0.03</span><span class="p">]]</span>
        
        <span class="n">path</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>
        <span class="n">patch</span> <span class="o">=</span> <span class="n">PathPatch</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="n">facecolor</span><span class="o">=</span><span class="s1">&#39;none&#39;</span><span class="p">,</span> <span class="n">edgecolor</span><span class="o">=</span><span class="s1">&#39;none&#39;</span><span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">add_patch</span><span class="p">(</span><span class="n">patch</span><span class="p">)</span> 
        
        <span class="c1"># Extend axis if needed</span>
        <span class="n">lower_lim</span><span class="p">,</span> <span class="n">upper_lim</span> <span class="o">=</span> <span class="n">ax</span><span class="o">.</span><span class="n">get_xlim</span><span class="p">()</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">box_end</span> <span class="o">&lt;</span> <span class="n">lower_lim</span><span class="p">):</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">set_xlim</span><span class="p">(</span><span class="n">box_end</span><span class="p">,</span> <span class="n">upper_lim</span><span class="p">)</span>
        
        <span class="k">if</span> <span class="p">(</span><span class="n">box_end</span> <span class="o">&gt;</span> <span class="n">upper_lim</span><span class="p">):</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">set_xlim</span><span class="p">(</span><span class="n">lower_lim</span><span class="p">,</span> <span class="n">box_end</span><span class="p">)</span>
            
        <span class="c1"># Create shading</span>
        <span class="k">if</span> <span class="n">feature_type</span> <span class="o">==</span> <span class="s1">&#39;negative&#39;</span><span class="p">:</span>
            <span class="n">colors</span> <span class="o">=</span>  <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([(</span><span class="mi">30</span><span class="p">,</span> <span class="mi">136</span><span class="p">,</span> <span class="mi">229</span><span class="p">),</span> <span class="p">(</span><span class="mi">255</span><span class="p">,</span> <span class="mi">255</span><span class="p">,</span> <span class="mi">255</span><span class="p">)])</span> <span class="o">/</span> <span class="mf">255.</span> <span class="c1"># np.array([(255, 13, 87), (255, 255, 255)]) / 255.</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">colors</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([(</span><span class="mi">255</span><span class="p">,</span> <span class="mi">13</span><span class="p">,</span> <span class="mi">87</span><span class="p">),</span> <span class="p">(</span><span class="mi">255</span><span class="p">,</span> <span class="mi">255</span><span class="p">,</span> <span class="mi">255</span><span class="p">)])</span> <span class="o">/</span> <span class="mf">255.</span>  <span class="c1"># np.array([(30, 136, 229), (255, 255, 255)]) / 255.</span>
        
        <span class="n">cm</span> <span class="o">=</span> <span class="n">matplotlib</span><span class="o">.</span><span class="n">colors</span><span class="o">.</span><span class="n">LinearSegmentedColormap</span><span class="o">.</span><span class="n">from_list</span><span class="p">(</span><span class="s1">&#39;cm&#39;</span><span class="p">,</span> <span class="n">colors</span><span class="p">)</span>
        
        <span class="n">_</span><span class="p">,</span> <span class="n">Z2</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">meshgrid</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">10</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="o">-</span><span class="mi">10</span><span class="p">,</span> <span class="mi">10</span><span class="p">))</span>
        <span class="n">im</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">Z2</span><span class="p">,</span> <span class="n">interpolation</span><span class="o">=</span><span class="s1">&#39;quadric&#39;</span><span class="p">,</span> <span class="n">cmap</span><span class="o">=</span><span class="n">cm</span><span class="p">,</span>
                        <span class="n">vmax</span><span class="o">=</span><span class="mf">0.01</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.3</span><span class="p">,</span>
                        <span class="n">origin</span><span class="o">=</span><span class="s1">&#39;lower&#39;</span><span class="p">,</span> <span class="n">extent</span><span class="o">=</span><span class="n">extent_shading</span><span class="p">,</span>
                        <span class="n">clip_path</span><span class="o">=</span><span class="n">patch</span><span class="p">,</span> <span class="n">clip_on</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">aspect</span><span class="o">=</span><span class="s1">&#39;auto&#39;</span><span class="p">)</span>
        <span class="n">im</span><span class="o">.</span><span class="n">set_clip_path</span><span class="p">(</span><span class="n">patch</span><span class="p">)</span>
        
        <span class="k">return</span> <span class="n">fig</span><span class="p">,</span> <span class="n">ax</span></div>
</div>

    
    <span class="c1"># =============================================================================</span>
    <span class="c1">#                           End of force plots function</span>
    <span class="c1"># =============================================================================</span>


</pre></div>

          </div>
          
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
<h1 class="logo"><a href="../../../index.html">XPER Documentation</a></h1>








<h3>Navigation</h3>
<p class="caption" role="heading"><span class="caption-text">Contents:</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../modules.html">XPER</a></li>
</ul>

<div class="relations">
<h3>Related Topics</h3>
<ul>
  <li><a href="../../../index.html">Documentation overview</a><ul>
  <li><a href="../../index.html">Module code</a><ul>
  </ul></li>
  </ul></li>
</ul>
</div>
<search id="searchbox" style="display: none" role="search">
  <h3 id="searchlabel">Quick search</h3>
    <div class="searchformwrapper">
    <form class="search" action="../../../search.html" method="get">
      <input type="text" name="q" aria-labelledby="searchlabel" autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false"/>
      <input type="submit" value="Go" />
    </form>
    </div>
</search>
<script>document.getElementById('searchbox').style.display = "block"</script>








        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="footer">
      &#169;2024, Sebastien Saurin, Sullivan Hué, Christophe Hurlin, Christophe Perignon.
      
      |
      Powered by <a href="https://www.sphinx-doc.org/">Sphinx 7.3.7</a>
      &amp; <a href="https://alabaster.readthedocs.io">Alabaster 0.7.16</a>
      
    </div>

    

    
  </body>
</html>